<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet"href="/css/styles.css">
  </head>
  <head>
    <title>Dashboard</title>
  </head>
    <link rel="stylesheet" href="/css/styles.css">
  </head>
  <body>
    <div id="parent-container" class="center-absolute">
      <h1>Welcome to the ChatRoom, <%= user.username %>!</h1>

      <div id="parent-container">
        <div id="posts-container" class="scrollable-div">
        <button id="scrollButton" style="display: none;">Scroll to Bottom</button>
      </div>
      </div>
      

      <!-- Posting Area -->
      <form id="postForm" action="/posting" method="post">
        <input type="hidden" id="post_user" value="<%= user.username %>">
        <label for="post_content">Content:</label>
        <input type="text" id="post_content" name="post_content" required>

        <div id="button-row">
          <button type="submit">Confirm</button>
        </div>
      </form>    

      <!-- Logout Button -->
      <form action="/logout" method="post">
        <input type="submit" value="Logout">
      </form>
    </div>


    <!-- Scrpit area to process auto update without refresh the code -->
    <script>
      // Define a local list to store the ids of rendered posts
      let renderedPosts = [];

      const fetchNewPosts = async () => {
        const response = await fetch('/api/posts');
        const newPosts = await response.json();
        let newPostAdded = false; // Flag a checker if a new post was added

        const postsContainer = document.getElementById('posts-container');
        const scrollButton = document.getElementById('scrollButton');
        
        newPosts.forEach(post => {
          // Only render the post if its id is not in the renderedPosts list
          if (!renderedPosts.includes(post.id)) {
            // A new post will be added, so set the checker to true
            newPostAdded = true;

            const postElement = document.createElement('div');
            postElement.classList.add('post');

            // Format the date and time
            // Create a new date object from the post's timestamp
            const postDate = new Date(post.posted_at);
            const formattedDate = postDate.toLocaleDateString(); // "MM/DD/YYYY"
            const formattedTime = postDate.toLocaleTimeString(); // "HH:MM:SS AM/PM"
            
            // formatting the inner HTML
            postElement.innerHTML = `<h2>${post.post_user}:</h2><p>${post.post_content}</p><p>at ${formattedDate} ${formattedTime}</p>`;
            
            // temporarily remove the scroll button before appending the post
            postsContainer.removeChild(scrollButton);
            // append the post
            postsContainer.appendChild(postElement);
            // re-append the scroll button
            postsContainer.appendChild(scrollButton);
            
            // Add the id to the renderedPosts list
            renderedPosts.push(post.id);
          }
        });

        if (newPostAdded) {
          // Show the "Scroll to bottom" button
          scrollButton.style.display = 'block';

          // Handle click on the "Scroll to bottom" button
          scrollButton.addEventListener('click', function() {
              postsContainer.scrollTop = postsContainer.scrollHeight;
              // Hide the button after clicking
              this.style.display = 'none';
          });
        }
      }

      fetchNewPosts(); // Fetch posts immediately after page load
      setInterval(fetchNewPosts, 1000); // Auto Update every 1 second


      // handling posting without refreshing the home page:

      document.getElementById('postForm').addEventListener('submit', function(event) {
        event.preventDefault(); // prevent the form from submitting the default way

        const postUser = document.getElementById('post_user').value;
        const postContent = document.getElementById('post_content').value;
        console.log(postUser)
        console.log(postContent)
        fetch('/posting', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ post_user: postUser, post_content: postContent }) // send the post content
        })
        .then(response => response.json()) // expecting a json response
        .then(json => {console.log(json);
          document.getElementById('post_content').value = ''; // Clear the input box after the server send a confirm(or error) message
          // Scroll to the bottom after setting
          const postsContainer = document.getElementById('posts-container');
          postsContainer.scrollTop = postsContainer.scrollHeight;
        })
        .catch(err => console.error('Error:', err));
      });




    </script>

  </body>
</html>
